<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tristrike</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
    <h1>Tristrike Game</h1>

    <!-- Signup Section -->
    <div id="signup-section">
        <h3>Signup</h3>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="email" id="signup-email" placeholder="Email">  
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signup()">Sign Up</button>
        <p id="signup-message"></p>
    </div>

    <!-- Login Section -->
    <div id="login-section">
        <h3>Login</h3>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p id="login-message"></p>
    </div>

    <!-- Main Section -->
    <div id="main-section" style="display: none;">
        <h2>Welcome, <span id="user-name"></span>!</h2>
        <button onclick="logout()">Logout</button>

        <div id="game-section" style="display: none;">
            <h2>Game Status</h2>
            <p>üí∞ Balance: <span id="userBal">--</span></p>
            <p>üèÜ Prize pool: <span id="prizePool">--</span></p>
            <p>‚è≥ Timer: <span id="game-timer">--</span> seconds</p>
            <p>üèÜ Winning Number: <span id="winning-number">--</span></p>
            <button id="betHere">Place Bet</button>

            <!-- Number Selection -->
            <div id="number-set-section">
                <h3>Select Your Combination</h3>
                <div id="number-buttons">
                    <div>
                        <button onclick="selectNumber(1)">1</button>
                        <button onclick="selectNumber(2)">2</button>
                        <button onclick="selectNumber(3)">3</button>
                    </div>
                    <div>
                        <button onclick="selectNumber(4)">4</button>
                        <button onclick="selectNumber(5)">5</button>
                        <button onclick="selectNumber(6)">6</button>
                    </div>
                    <div>
                        <button onclick="selectNumber(7)">7</button>
                        <button onclick="selectNumber(8)">8</button>
                        <button onclick="selectNumber(9)">9</button>
                    </div>
                    <div>
                        <button onclick="selectNumber(10)">10</button>
                        <button onclick="selectNumber(11)">11</button>
                        <button onclick="selectNumber(12)">12</button>
                    </div>
                </div>
                <p>Selected Combination: <span id="selected-combination">-</span></p>
            </div>

            <div>
                <h3>Buy Coins</h3>
                <div>
                    <input type="radio" id="gcash" name="payment-method" value="GCash" checked>
                    <label for="gcash">GCash</label>
                    <input type="radio" id="paymaya" name="payment-method" value="PayMaya">
                    <label for="paymaya">PayMaya</label>
                </div>
                <button onclick="buyCoins(1000)">Buy 1000 Coins</button>
                <button onclick="buyCoins(100)">Buy 100 Coins</button>
                <button onclick="buyCoins(50)">Buy 50 Coins</button>
                <button onclick="buyCoins(20)">Buy 20 Coins</button>
            </div>
            <p>Current Balance: <span id="balance">0</span> coins</p>
            

        </div>
    </div>

    <script>
        const socket = io("http://localhost:3000");
        const betAmount = 20; // Define bet amount (20 coins)
        let selectedNumbers = [];
    
        // ‚úÖ Signup
        function signup() {
            const username = document.getElementById("signup-username").value;
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
    
            console.log("üîµ Signup request:", { username, email, password });
            socket.emit("signup", { username, email, password });
    
            socket.on("signup_response", (response) => {
                console.log("üü¢ Signup response:", response);
                document.getElementById("signup-message").textContent = response.message;
            });
        }
    
        // ‚úÖ Login
        function login() {
            const username = document.getElementById("login-username").value;
            const password = document.getElementById("login-password").value;
    
            console.log("üîµ Login request:", { username, password });
            socket.emit("login", { username, password });
    
            socket.on("login_response", (response) => {
                console.log("üü¢ Login response:", response);
                if (response.success) {
                    document.getElementById("signup-section").style.display = "none";
                    document.getElementById("login-section").style.display = "none";
                    document.getElementById("main-section").style.display = "block";
                    document.getElementById("user-name").textContent = response.user.username;
    
                    localStorage.setItem("token", response.token);
                    localStorage.setItem("userId", response.user.id);
    
                    console.log("‚úÖ Login successful, fetching data...");
                    socket.emit("user_balance");
                    socket.emit("prize_pool", { gameId: 1 });
                    authenticateUser();
                } else {
                    document.getElementById("login-message").textContent = response.message;
                }
            });
        }
    
        // ‚úÖ Authentication
        function authenticateUser() {
            const token = localStorage.getItem("token");
            console.log("üîµ Authenticating with token:", token);
            if (!token) return;
    
            socket.emit("authenticate", token);
    
            socket.on("auth_response", (response) => {
                console.log("üü¢ Auth response:", response);
                if (response.success) {
                    document.getElementById("main-section").style.display = "block";
                    socket.emit("get_game_state");
                    socket.emit("user_balance");
                    socket.emit("prize_pool", { gameId: 1 });
                } else {
                    console.warn("‚ùå Authentication failed, clearing token...");
                    localStorage.removeItem("token");
                    window.location.reload();
                }
            });
        }
    
        // ‚úÖ Update Balance and Prize Pool
        socket.on("user_balance", (data) => {
            console.log("üü¢ User balance:", data);
            document.getElementById("userBal").textContent = data.balance;
        });
    
        socket.on("prize_pool_response", (data) => {
            console.log("üü¢ Prize pool response:", data);
            document.getElementById("prizePool").textContent = data.prizePool;
        });
    
        // ‚úÖ Game State Update
        socket.on("game_update", (data) => {
            console.log("üü¢ Game update:", data);
            document.getElementById("game-timer").textContent = data.timer;
            document.getElementById("winning-number").textContent = data.winningNumber;
            document.getElementById("game-section").style.display = "block";
        });
    
        // ‚úÖ Select Number Logic
        function selectNumber(number) {
            if (selectedNumbers.length < 3) {
                selectedNumbers.push(number);
            } else {
                selectedNumbers.shift();
                selectedNumbers.push(number);
            }
            console.log("üîµ Selected combination:", selectedNumbers);
            document.getElementById("selected-combination").textContent = selectedNumbers.join("-");
        }
    
        // ‚úÖ Place Bet Logic
        let hasPlacedBet = false;
        function placeBet() {
            if (selectedNumbers.length !== 3) {
                alert("Please select 3 numbers before placing a bet!");
                console.warn("‚ùå Bet failed: Incomplete combination");
                return;
            }
    
            const userId = localStorage.getItem("userId");
            if (!userId) {
                alert("User ID not found. Please log in again.");
                console.warn("‚ùå Bet failed: User ID not found");
                return;
            }
    
            console.log("üîµ Getting latest game for bet...");
            socket.emit("get_latest_game");
        }
    
        socket.on("latest_game_response", (response) => {
            console.log("üü¢ Latest game response:", response);
            if (!response.success) {
                alert("No ongoing game found!");
                return;
            }
    
            const latestGameId = response.gameId;
            const userId = localStorage.getItem("userId");
    
            console.log("üîµ Placing bet:", {
                userId,
                gameId: latestGameId,
                chosenNumbers: selectedNumbers,
                betAmount
            });
    
            socket.emit("place_bet", {
                userId,
                gameId: latestGameId,
                chosenNumbers: selectedNumbers,
                betAmount
            });
        });
    
        socket.on("bet_response", (response) => {
            console.log("üü¢ Bet response:", response);
            if (response.success) {
                alert(`‚úÖ Bet placed successfully! Chosen combination: ${selectedNumbers.join("-")}`);
                hasPlacedBet = true;
                socket.emit("user_balance");
                socket.emit("prize_pool", { gameId: response.gameId });
            } else {
                alert("‚ùå Bet failed: " + response.message);
                console.warn("‚ùå Bet failed:", response.message);
            }
        });
    
        // ‚úÖ Handle Winner Announcement
        socket.on("winner_announcement", (data) => {
            console.log("üü¢ Winner announcement:", data);
            if (data.userId === localStorage.getItem("userId")) {
                alert(`üéâ Congratulations! You won ${data.prizeAmount} coins!`);
            }
            socket.emit("user_balance");
            socket.emit("prize_pool", { gameId: 1 });
        });

        function buyCoins(amount) {
            // Get the selected payment method
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            
            if (!paymentMethod) {
                alert("Please select a payment method.");
                return;
            }

            console.log(`üîµ Buying ${amount} coins using ${paymentMethod}...`);
            
            socket.emit("buy_coins", { 
                amount, 
                paymentMethod 
            });
        }

        socket.on("buy_coins_response", (data) => {
            if (data.success) {
                alert(`‚úÖ ${data.message}`);
                updateBalanceDisplay(data.balance);
            } else {
                alert("‚ùå Failed to buy coins: " + data.message);
            }
        });



        function updateBalanceDisplay(balance) {
            document.getElementById("balance").innerText = balance;
        }
    
        // ‚úÖ Logout
        function logout() {
            console.log("üîµ Logging out...");
            socket.emit("logout");
            localStorage.clear();
            window.location.reload();
        }
    
        // ‚úÖ Start Authentication on Load
        window.onload = () => {
            console.log("üîµ Initializing authentication...");
            authenticateUser();
        };
    
        // ‚úÖ Attach event listeners
        document.getElementById("betHere").addEventListener("click", placeBet);
    </script>    
</body>
</html>
